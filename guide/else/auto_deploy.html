<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>搭建一个自动化部署服务 | Jiuto&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jiuto_blog/assets/css/0.styles.6a6be926.css" as="style"><link rel="preload" href="/jiuto_blog/assets/js/app.77f799ef.js" as="script"><link rel="preload" href="/jiuto_blog/assets/js/2.306ea56a.js" as="script"><link rel="preload" href="/jiuto_blog/assets/js/17.0d79a0a6.js" as="script"><link rel="prefetch" href="/jiuto_blog/assets/js/10.42c154c6.js"><link rel="prefetch" href="/jiuto_blog/assets/js/11.fe63c528.js"><link rel="prefetch" href="/jiuto_blog/assets/js/12.6ec84949.js"><link rel="prefetch" href="/jiuto_blog/assets/js/13.51e90ae2.js"><link rel="prefetch" href="/jiuto_blog/assets/js/14.efbcf178.js"><link rel="prefetch" href="/jiuto_blog/assets/js/15.668c1451.js"><link rel="prefetch" href="/jiuto_blog/assets/js/16.fc12faa3.js"><link rel="prefetch" href="/jiuto_blog/assets/js/18.750fe351.js"><link rel="prefetch" href="/jiuto_blog/assets/js/19.85d2e4c7.js"><link rel="prefetch" href="/jiuto_blog/assets/js/20.4906521d.js"><link rel="prefetch" href="/jiuto_blog/assets/js/21.09ab7d50.js"><link rel="prefetch" href="/jiuto_blog/assets/js/22.795acdf4.js"><link rel="prefetch" href="/jiuto_blog/assets/js/23.9c74384b.js"><link rel="prefetch" href="/jiuto_blog/assets/js/24.da4d73f2.js"><link rel="prefetch" href="/jiuto_blog/assets/js/25.fc63dcb1.js"><link rel="prefetch" href="/jiuto_blog/assets/js/26.b3ca0d63.js"><link rel="prefetch" href="/jiuto_blog/assets/js/27.b66d1d06.js"><link rel="prefetch" href="/jiuto_blog/assets/js/28.f630f291.js"><link rel="prefetch" href="/jiuto_blog/assets/js/29.9207d993.js"><link rel="prefetch" href="/jiuto_blog/assets/js/3.a4769620.js"><link rel="prefetch" href="/jiuto_blog/assets/js/30.0357d1e0.js"><link rel="prefetch" href="/jiuto_blog/assets/js/31.560fd065.js"><link rel="prefetch" href="/jiuto_blog/assets/js/32.e211d102.js"><link rel="prefetch" href="/jiuto_blog/assets/js/33.bae937df.js"><link rel="prefetch" href="/jiuto_blog/assets/js/34.bd680e48.js"><link rel="prefetch" href="/jiuto_blog/assets/js/35.6bfeb231.js"><link rel="prefetch" href="/jiuto_blog/assets/js/36.a5795e3e.js"><link rel="prefetch" href="/jiuto_blog/assets/js/37.4e7195fa.js"><link rel="prefetch" href="/jiuto_blog/assets/js/38.e23dc037.js"><link rel="prefetch" href="/jiuto_blog/assets/js/39.11c26ceb.js"><link rel="prefetch" href="/jiuto_blog/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/jiuto_blog/assets/js/40.f99e632d.js"><link rel="prefetch" href="/jiuto_blog/assets/js/41.50fc5a77.js"><link rel="prefetch" href="/jiuto_blog/assets/js/42.ab0b88ca.js"><link rel="prefetch" href="/jiuto_blog/assets/js/43.1853532c.js"><link rel="prefetch" href="/jiuto_blog/assets/js/44.b53dcff3.js"><link rel="prefetch" href="/jiuto_blog/assets/js/45.5000147c.js"><link rel="prefetch" href="/jiuto_blog/assets/js/46.33fc7476.js"><link rel="prefetch" href="/jiuto_blog/assets/js/47.9d5e6a6e.js"><link rel="prefetch" href="/jiuto_blog/assets/js/48.de8c54d3.js"><link rel="prefetch" href="/jiuto_blog/assets/js/49.dfd0c69d.js"><link rel="prefetch" href="/jiuto_blog/assets/js/5.6eff8140.js"><link rel="prefetch" href="/jiuto_blog/assets/js/50.3950dbe4.js"><link rel="prefetch" href="/jiuto_blog/assets/js/51.d6ed25db.js"><link rel="prefetch" href="/jiuto_blog/assets/js/52.35264bc4.js"><link rel="prefetch" href="/jiuto_blog/assets/js/53.66c750c8.js"><link rel="prefetch" href="/jiuto_blog/assets/js/54.5bd622b8.js"><link rel="prefetch" href="/jiuto_blog/assets/js/55.49a89d4c.js"><link rel="prefetch" href="/jiuto_blog/assets/js/56.9a136df1.js"><link rel="prefetch" href="/jiuto_blog/assets/js/57.7cbd1f02.js"><link rel="prefetch" href="/jiuto_blog/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/jiuto_blog/assets/js/7.0797a358.js"><link rel="prefetch" href="/jiuto_blog/assets/js/8.e32f907d.js"><link rel="prefetch" href="/jiuto_blog/assets/js/9.f5d55933.js">
    <link rel="stylesheet" href="/jiuto_blog/assets/css/0.styles.6a6be926.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jiuto_blog/" class="home-link router-link-active"><!----> <span class="site-name">Jiuto's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Jiuto" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Jiuto" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/js/eventBus.html" class="sidebar-link">用Map写一个EventBus事件总线</a></li><li><a href="/jiuto_blog/guide/js/promise.html" class="sidebar-link">手写一个Promise</a></li><li><a href="/jiuto_blog/guide/js/babble_capture.html" class="sidebar-link">冒泡与捕获</a></li><li><a href="/jiuto_blog/guide/js/debounce_throttle.html" class="sidebar-link">防抖与节流</a></li><li><a href="/jiuto_blog/guide/js/clone.html" class="sidebar-link">浅拷贝和深拷贝</a></li><li><a href="/jiuto_blog/guide/js/module.html" class="sidebar-link">ES6 Module</a></li><li><a href="/jiuto_blog/guide/js/template.html" class="sidebar-link">模板引擎原理</a></li><li><a href="/jiuto_blog/guide/js/closure.html" class="sidebar-link">理解js闭包</a></li><li><a href="/jiuto_blog/guide/js/proto.html" class="sidebar-link">理解js原型、原型链和继承</a></li><li><a href="/jiuto_blog/guide/js/new.html" class="sidebar-link">手写 new 操作符</a></li><li><a href="/jiuto_blog/guide/js/bind.html" class="sidebar-link">手写 bind</a></li><li><a href="/jiuto_blog/guide/js/apply_call.html" class="sidebar-link">手写 apply 和 call</a></li><li><a href="/jiuto_blog/guide/js/let_const.html" class="sidebar-link">let、const和块级作用域</a></li><li><a href="/jiuto_blog/guide/js/curry.html" class="sidebar-link">柯里化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/css/flex.html" class="sidebar-link">flex布局</a></li><li><a href="/jiuto_blog/guide/css/layout.html" class="sidebar-link">常见布局</a></li><li><a href="/jiuto_blog/guide/css/bfc.html" class="sidebar-link">BFC 块格式化上下文</a></li><li><a href="/jiuto_blog/guide/css/stacking_context.html" class="sidebar-link">层叠上下文、层叠层级、层叠顺序</a></li><li><a href="/jiuto_blog/guide/css/center.html" class="sidebar-link">水平居中、垂直居中</a></li><li><a href="/jiuto_blog/guide/css/grid.html" class="sidebar-link">grid 网格布局</a></li><li><a href="/jiuto_blog/guide/css/css3.html" class="sidebar-link">CSS3 动画</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/vue/nextTick.html" class="sidebar-link">vue中$nextTick的实现原理</a></li><li><a href="/jiuto_blog/guide/vue/responsive.html" class="sidebar-link">简单实现vue响应式原理</a></li><li><a href="/jiuto_blog/guide/vue/initData.html" class="sidebar-link">源码分析vue响应式原理</a></li><li><a href="/jiuto_blog/guide/vue/initWatch.html" class="sidebar-link">源码分析vue watch侦听器</a></li><li><a href="/jiuto_blog/guide/vue/patch.html" class="sidebar-link">源码阅读vue VirtualDOM 和 diff</a></li><li><a href="/jiuto_blog/guide/vue/initComputed.html" class="sidebar-link">源码分析vue computed</a></li><li><a href="/jiuto_blog/guide/vue/router.html" class="sidebar-link">源码阅读vue-router</a></li><li><a href="/jiuto_blog/guide/vue/vuex.html" class="sidebar-link">源码阅读vuex</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/webpack/webpack_template.html" class="sidebar-link">webpack多页面打包方法工具和模板</a></li><li><a href="/jiuto_blog/guide/webpack/babeltry.html" class="sidebar-link">通过babel手撸超简化版webpack</a></li><li><a href="/jiuto_blog/guide/webpack/plugin_loader.html" class="sidebar-link">手写webpack plugin 和 loader</a></li><li><a href="/jiuto_blog/guide/webpack/babel_plugin.html" class="sidebar-link">写一个Babel插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/browser/eventloop.html" class="sidebar-link">event loop 事件循环</a></li><li><a href="/jiuto_blog/guide/browser/render.html" class="sidebar-link">浏览器渲染机制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络与安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/network/http.html" class="sidebar-link">http、https</a></li><li><a href="/jiuto_blog/guide/network/cache.html" class="sidebar-link">浏览器缓存</a></li><li><a href="/jiuto_blog/guide/network/cross.html" class="sidebar-link">跨域</a></li><li><a href="/jiuto_blog/guide/network/security.html" class="sidebar-link">web 安全</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiuto_blog/guide/else/ele_expend.html" class="sidebar-link">如何在element-ui中拓展一个新的组件</a></li><li><a href="/jiuto_blog/guide/else/cli.html" class="sidebar-link">搭建一个脚手架工具</a></li><li><a href="/jiuto_blog/guide/else/utils.html" class="sidebar-link">搭建一个方法库</a></li><li><a href="/jiuto_blog/guide/else/auto_deploy.html" aria-current="page" class="active sidebar-link">搭建一个自动化部署服务</a></li><li><a href="/jiuto_blog/guide/else/docker_verdaccio.html" class="sidebar-link">在docker中通过Verdaccio搭建一个私有npm库</a></li><li><a href="/jiuto_blog/guide/else/docker_initSql.html" class="sidebar-link">通过Dockerfile在docker中初始化mysql表</a></li><li><a href="/jiuto_blog/guide/else/eslint_prettier.html" class="sidebar-link">在vue/react项目中配置eslint + prettier</a></li><li><a href="/jiuto_blog/guide/else/karma_mocha.html" class="sidebar-link">搭建一个由 karma + mocha + chai + Istanbul 组成的基础测试工具</a></li><li><a href="/jiuto_blog/guide/else/optimization.html" class="sidebar-link">首屏加载优化</a></li><li><a href="/jiuto_blog/guide/else/docker.html" class="sidebar-link">如何使用docker发布项目</a></li><li><a href="/jiuto_blog/guide/else/interview.html" class="sidebar-link">面试路漫漫</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="搭建一个自动化部署服务"><a href="#搭建一个自动化部署服务" class="header-anchor">#</a> 搭建一个自动化部署服务</h2> <blockquote><p>本文讲述如何搭建一个前端自动化部署服务，示例项目代码参考<a href="https://github.com/Jiuto/auto_deploy.git" target="_blank" rel="noopener noreferrer">auto_deploy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>部署服务前端只有一个简单的html，后端使用 koa，通过 pm2 启动。</p> <p>服务功能实现通过 child_process 执行命令，使用 taskkill 杀死进程，部署的目标项目使用 http-server 启动。</p> <p>需要提前在安装全局 pm2 和 http-server</p></blockquote> <hr> <h3 id="编写部署服务"><a href="#编写部署服务" class="header-anchor">#</a> 编写部署服务</h3> <ol><li>部署服务项目的目录结构</li></ol> <img src="/jiuto_blog/imgs/else/auto_deploy/file.png" alt="目录结构"> <p>static：用于存放目标项目打包后的文件</p> <p>statichtml：用于存放部署服务的前端界面</p> <p>app.js：部署服务的后端</p> <ol start="2"><li>部署服务的依赖</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;koa-mount&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;taskkill&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.1.0&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>部署服务的后端</li></ol> <p>app.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-mount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> reloadKoa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/favivon.ico'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/reload'</span><span class="token punctuation">,</span> reloadKoa<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

reloadKoa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 部署功能</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> 
    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/statichtml/index.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8003</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>监听8003端口，访问'/'根目录时，返回<code>/statichtml/index.html</code>页面。</p> <ol start="4"><li>部署服务的前端</li></ol> <p><code>/statichtml/index.html</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>分支名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span><span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>master<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>连接环境：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>select<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>select<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://127.0.0.1:3001/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>开发环境<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleClick()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>部署<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>output<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> $btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> $output <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> $input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> $select <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;select&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> branch <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>$input<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>$select<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    $btn<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    $btn<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $output<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&quot;正在部署，请耐心等待&quot;</span><span class="token punctuation">;</span>

    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/reload?branch=</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> branch <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;proxy=</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> proxy<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        $output<span class="token punctuation">.</span>innerText <span class="token operator">=</span> text<span class="token punctuation">;</span>
        $btn<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $btn<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前端页面最简易的情况只需要一个部署按钮，用于发起部署请求。</p> <p>可增加一些表单交互，用于拓展部署服务功能，例如分支选择，目标项目连接的后端ip等等。</p> <p>点击部署按钮，请求当前服务端口的'/reload'接口，带上分支和代理ip两个参数，对接口返回的text进行展示，并取消按钮禁用。</p> <ol start="5"><li>在编写部署功能功能前，先声明一些常量、变量和方法</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这些参数均可从前端配置</span>
<span class="token keyword">const</span> protocol <span class="token operator">=</span> <span class="token string">&quot;https&quot;</span><span class="token punctuation">;</span> <span class="token comment">// git clone 命令的协议</span>
<span class="token keyword">const</span> projectUrl <span class="token operator">=</span> <span class="token string">&quot;github.com/Jiuto/ding_yapi.git&quot;</span><span class="token punctuation">;</span> <span class="token comment">// git clone 命令的项目地址</span>
<span class="token keyword">const</span> projectDir <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/ding_yapi'</span><span class="token punctuation">;</span> <span class="token comment">// 目标项目名</span>
<span class="token keyword">const</span> staticDir <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/static/dist'</span><span class="token punctuation">;</span> <span class="token comment">// 存放打包文件的路径</span>
<span class="token keyword">const</span> buildStaticDir <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/ding_yapi/client/dist'</span><span class="token punctuation">;</span> <span class="token comment">// 目标项目打包后的文件路径</span>

<span class="token keyword">const</span> git_username<span class="token operator">=</span><span class="token string">'username'</span><span class="token punctuation">;</span> <span class="token comment">// git 用户名</span>
<span class="token keyword">const</span> git_password<span class="token operator">=</span><span class="token string">'password'</span><span class="token punctuation">;</span> <span class="token comment">// git 密码</span>

<span class="token comment">// 目标项目启动的进程</span>
<span class="token keyword">var</span> subprocess <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// 删除文件</span>
<span class="token keyword">function</span> <span class="token function">deleteFolder</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 目录存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文件夹</span>
            files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回所有文件名数组</span>
            files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> curPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文件夹</span>
                    <span class="token function">deleteFolder</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 文件</span>
                    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 文件</span>
            fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文件</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝文件</span>
<span class="token keyword">function</span> <span class="token function">copyFolder</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">from</span><span class="token punctuation">,</span> to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 目录存在</span>
        files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> targetPath <span class="token operator">=</span> <span class="token keyword">from</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
            <span class="token keyword">var</span> toPath <span class="token operator">=</span> to <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文件夹</span>
                <span class="token function">copyFolder</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> toPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 文件</span>
                fs<span class="token punctuation">.</span><span class="token function">copyFileSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> toPath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝文件</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 目录不存在</span>
        fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建文件</span>
        <span class="token function">copyFolder</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>部署功能</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>reloadKoa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 解析入参</span>
        <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>branch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明两个变量用于存放拉取代码和更新环境两个功能的执行结果</span>
        <span class="token keyword">var</span> rtn1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            rtn2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 是否重新克隆项目</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branch<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 删除上一次拉取的项目</span>
            <span class="token function">deleteFolder</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 构建克隆命令</span>
            <span class="token keyword">let</span> cmdStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git clone -b </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> branch <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> protocol <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">://</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> git_username <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> git_password <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> projectUrl<span class="token punctuation">;</span>
            <span class="token comment">// 调用执行克隆命令的方法</span>
            rtn1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">reloadCode</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>

        <span class="token comment">// 是否切换代理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 构建启动项目命令，将目标项目部署在8002端口</span>
            <span class="token keyword">let</span> cmdStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http-server .\\static\\dist -p 8002 --proxy </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> proxy<span class="token punctuation">;</span>
            <span class="token comment">// 调用执行启动项目命令的方法</span>
            rtn2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">changeProxy</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 整合返回结果</span>
        <span class="token keyword">var</span> rtn <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> rtn1<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">||</span> rtn2<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">?</span> <span class="token number">200</span> <span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
            msg<span class="token operator">:</span> rtn1<span class="token punctuation">.</span>msg 
                        <span class="token operator">?</span> rtn2<span class="token punctuation">.</span>msg
                            <span class="token operator">?</span> rtn1<span class="token punctuation">.</span>msg <span class="token operator">+</span> <span class="token string">' and '</span> <span class="token operator">+</span> rtn2<span class="token punctuation">.</span>msg
                            <span class="token operator">:</span> rtn1<span class="token punctuation">.</span>msg
                        <span class="token operator">:</span> rtn2<span class="token punctuation">.</span>msg
                            <span class="token operator">?</span> rtn2<span class="token punctuation">.</span>msg
                            <span class="token operator">:</span> <span class="token string">'parameter can nott be empty'</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 响应</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> rtn<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> rtn<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>执行克隆命令的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reloadCode</span><span class="token punctuation">(</span><span class="token parameter">cmdStr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            child_process<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 克隆项目</span>
            process<span class="token punctuation">.</span><span class="token function">chdir</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">)</span> <span class="token comment">// 进入子目录</span>
            child_process<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm install</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安装依赖</span>
            child_process<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run build</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打包项目</span>
            process<span class="token punctuation">.</span><span class="token function">chdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span> <span class="token comment">// 返回根目录</span>
            <span class="token function">deleteFolder</span><span class="token punctuation">(</span>staticDir<span class="token punctuation">)</span> <span class="token comment">// 删除原静态文件</span>
            <span class="token function">copyFolder</span><span class="token punctuation">(</span>buildStaticDir<span class="token punctuation">,</span> staticDir<span class="token punctuation">)</span> <span class="token comment">// 拷贝文件</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
                msg<span class="token operator">:</span> <span class="token string">'load code successful'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
                msg<span class="token operator">:</span> <span class="token string">'load failed, error message:\n'</span> <span class="token operator">+</span> e
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行启动项目命令的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">changeProxy</span><span class="token punctuation">(</span><span class="token parameter">cmdStr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> result2 <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 项目已启动，则杀死进程</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>subprocess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> <span class="token function">taskkill</span><span class="token punctuation">(</span>subprocess<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        subprocess <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动 http-server</span>
        subprocess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            result2<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
            result2<span class="token punctuation">.</span>msg <span class="token operator">+=</span> <span class="token string">'http-server failed, error message:\n'</span> <span class="token operator">+</span> err<span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result2<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        result2<span class="token punctuation">.</span>msg <span class="token operator">+=</span> <span class="token string">'set proxy successful'</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="启动部署服务"><a href="#启动部署服务" class="header-anchor">#</a> 启动部署服务</h3> <ol start="7"><li>进入auto_deploy目录，执行<code>pm2 start app.js</code>启动部署服务</li></ol> <img src="/jiuto_blog/imgs/else/auto_deploy/pm2.png" alt="pm2"> <p>随后，在本地8003端口即可看到部署服务的前端页面</p> <img src="/jiuto_blog/imgs/else/auto_deploy/html.png" alt="部署服务前端页面"> <h3 id="自动化部署"><a href="#自动化部署" class="header-anchor">#</a> 自动化部署</h3> <p>正在部署</p> <img src="/jiuto_blog/imgs/else/auto_deploy/deploy.png" alt="正在部署"> <p>dist</p> <img src="/jiuto_blog/imgs/else/auto_deploy/dist.png" alt="dist"> <p>httpserver</p> <img src="/jiuto_blog/imgs/else/auto_deploy/httpserver.png" alt="httpserver"></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jiuto_blog/guide/else/utils.html" class="prev">
        搭建一个方法库
      </a></span> <span class="next"><a href="/jiuto_blog/guide/else/docker_verdaccio.html">
        在docker中通过Verdaccio搭建一个私有npm库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/jiuto_blog/assets/js/app.77f799ef.js" defer></script><script src="/jiuto_blog/assets/js/2.306ea56a.js" defer></script><script src="/jiuto_blog/assets/js/17.0d79a0a6.js" defer></script>
  </body>
</html>
